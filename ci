#!/usr/bin/env bash

cat <<INFO
This is the Everest CI script.
... called as $0
... working directory is $(pwd)
... environment: $(uname -a)
INFO

# Sorry, everyone
if (( ${BASH_VERSION%%.*} < 4 )); then
  echo "This script requires Bash >= 4. On OSX, try: brew install bash"
  exit 1
fi

# CI runs [bash -c path/to/ci] without [--login].
if [[ -f ~/.bash_profile ]]; then
  source ~/.bash_profile
fi

# Any error is fatal.
set -e
set -o pipefail
# set -x # uncomment for debugging.

# Checks that the current directory ends with $1
check_pwd_ends_with () {
  pwd=$(pwd)
  if [[ ${pwd%$1} == $pwd ]]; then
    echo "I don't seem to be in the right repository"
    exit 1
  fi
}

UBUNTU_SCRIPT=https://raw.githubusercontent.com/project-everest/everest/master/ubuntu-from-scratch

# Main commands.
case "$1" in
  fstar-ci)
    # Run the test suite minus the long tests (e.g. crypto)
    check_pwd_ends_with "FStar"
    ;;

  fstar-nightly)
    # Run the test suite including the long tests and the examples directory
    check_pwd_ends_with "FStar"
    ;;

  mitls-ci)
    if [ ! -f miTLS_icla.txt ]; then
      echo "I don't seem to be in the right directory, bailing"
      exit 1
    fi
    if [[ $CI_LOGS == "" ]]; then
      echo "Don't know where to checkout the logs"
      exit 1
    fi

    # Clone F* from the specified revision, set FSTAR_HOME
    if [ ! -d fstar ]; then
      mkdir -p fstar && cd fstar
      git init
      git remote add origin https://github.com/FStarLang/FStar/
      cd ..
    fi
    cd fstar
    git fetch origin
    git reset --hard $(cat ../.fstar_version)
    make -C src/ocaml-output clean
    make -C src/ocaml-output -j 15
    cd ..
    export FSTAR_HOME=$(pwd)/fstar

    # Determine where the logs are going
    LOG_OUT=mitls-$(date +%Y%m%d%H%M%S).out
    LOG_ERR=mitls-$(date +%Y%m%d%H%M%S).err

    # The actual CI
    if ! make -C src/tls all-ver tls-ffi -j 15 \
      2> >( tee $CI_LOGS/$LOG_ERR | sed s/^/STDERR : / >&2 ) \
      | tee $CI_LOGS/$LOG_OUT
    then
      echo "BUILD FAILED"
    else
      echo "BUILD SUCCEEDED"
    fi

    # Commit & push the logs
    cd $CI_LOGS
    git add $LOG_OUT
    git add $LOG_ERR
    git commit -am "[miTLS CI] regular continuous integration"
    git push
    ;;

  everest-ci)
    # Clone all projects together and make sure they test and build together
    check_pwd_ends_with "everest"
    ;;

  everest-nightly-check)
    # Start a fresh docker container that sets up everything, checks that
    # everything builds and runs on a fresh Ubuntu setup
    yes | docker run ubuntu bash -c "$(cat ubuntu-from-scratch)" | tee docker-log
    if [[ $(cat docker-log |Â tail -n 1) != "EVEREST-SUCCESS" ]]; then
      echo "Docker script did not reach completion -- failure"
      exit 1
    fi
    ;;

  everest-nightly-move)
    # Try to move the package to their last revision
    ;;

  *)
    cat <<USAGE
USAGE: $0 ACTION

ACTIONS:
  fstar-ci
  fstar-nightly
  mitls-ci
  everest-ci
  everest-nightly-check
  everest-nightly-move

REMARKS:
  Read this script's source code for more explanations. It has comments.
USAGE
    ;;
esac

